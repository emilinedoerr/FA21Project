---
title: "Doerr Reproducing Microarray Analysis"
output: html_notebook
---

## Differential gene expression analysis with Microarray Data

References:
# Normalize by quantiles http://jtleek.com/genstats/inst/doc/02_05_normalization.html
# Target Prediction with MiRTarBase
https://www.bioconductor.org/packages/devel/bioc/vignettes/multiMiR/inst/doc/multiMiR.html

Dataset:
Affymetrix Multispecies miRNA-4 Array

Contents:
* Setup
* Read Data
* Pre-processing
* Linear Regression
* Map Probe Ids
* References

## Install/Load Packages
```{r}
# Installs
install.packages("devtools")
install.packages("BiocManager")
library(BiocManager)

# install bioconductor libraries
BiocManager::install(c("GEOquery","affy"))

# Dataset is Affymetrix Multispecies miRNA-4 Array
BiocManager::install(c("oligo", "pd.mirna.4.0"))
BiocManager::install("multiMiR")

# load libraries
library(GEOquery)
library(limma)
library(affy)
library(oligo)
library(pd.mirna.4.0)
library(devtools)
library(Biobase)
library(preprocessCore)
library(multiMiR)
```

## File setup
```{r}
# set working directory for download
working_dir <- dirname(rstudioapi::getActiveDocumentContext()$path)
setwd(working_dir)

# download CEL tar
getGEOSuppFiles("GSE169290")

# Directory with tar
raw_dir <- paste(working_dir, "/GSE169290/", sep = "")

# Open raw tar and store cel files
untar(paste(raw_dir, "GSE169290_RAW.tar", sep = ""))
cel_files <- list.files("./", pattern = "CEL")

# Store raw data
raw_dat <- read.celfiles(cel_files, pkgname="pd.mirna.4.0")

```


# Microarray Analysis
```{r}
# Correct intensity backgrounds in raw data by RMA
eset <- rma(raw_dat)

# Convert to an expression matrix
expr<-exprs(eset)

# Normalize by quantiles
norm_expr <- normalize.quantiles(expr)
#norm_expr <- normalize.quantiles.robust(expr, n.remove = 5)

# TODO
# remove top and bottom five

colnames(norm_expr) <- gsub("_.*.CEL.gz","",colnames(eset))
#colnames(norm_expr2) <- gsub("_.*.CEL.gz","",colnames(norm_expr2))
#sample names
#colnames(norm_expr) <- gsub(".CEL.gz","",gsub(".*_","",colnames(expr)))

# Visualize the distribution of expression values using boxplot
#boxplot(log2(norm_expr+1), use.cols=TRUE, las=2,cex.axis=0.8, outline = F)

#pdata <- pData(eset)
#edata <- as.data.frame(exprs(eset))
#fdata <- fData(eset)
#edata <- log2(edata + 1)
#edata <- edata[rowMeans(edata) > 3, ]
#colramp <- colorRampPalette(c(3,"white", 2))(20)
#plot(density(norm_expr[,1]),col=colramp[1],lwd=3,ylim=c(0,.20))
#for(i in 2:20){lines(density(edata[,i]),lwd=3,col=colramp[i])}


## Differential gene expression with limma moderated t-statistics
# csv with sample descriptions
sample_file <- read.csv(file="sample_descriptions.csv")
samples <- as.data.frame(sample_file)

# Create design matrix for healthy vs unhealthy
groups <- samples[2,]
groups <- gsub("unhealthy","1",groups)
groups <- gsub("healthy","0",groups)
factor <- as.factor(groups)
design <- model.matrix(~ 0+factor, data=factor)
colnames(design)<-c("healthy","unhealthy")
# Contrast matrix
contrast.matrix<-makeContrasts(unhealthy-healthy, levels=design)

# fit the expression data into a linear model
fit <- lmFit(eset, design)
fit <- contrasts.fit(fit, contrast.matrix)

# Empirical Bayes to adjust variances, computes t-stat, std. error, logFC, log odd
fit2 <- eBayes(fit)

# toptable to summarize results
results <- topTable(fit2, number = 50000)

head(results)

## t-statistic for each gene with p-value
#stats <- cbind(results$B, results$P.Value, results$t)
#head(stats)

# top 5 up and downregulated in MUO vs MHO (Table 2)



# volcano plot
# https://biocorecrg.github.io/CRG_RIntroduction/volcano-plots.html

```

```{r}

```

# Target prediction with miRTarBase
* if none found, use TargetScanHuman
```{r}
# Remove ending in miRNA identifiers to match miRTarBase
rownames(results) <- gsub("_st","",rownames(results))
miRNAs <- rownames(results)
# Query database for validated targets using miRNA ids
multimr_results <- get_multimir(org = 'mmu', mirna = miRNAs, table = 'validated', summary = TRUE)
miRtb_data <- multimr_results@data
head(miRtb_data)
colnames(miRtb_data)
head(results)
# add a column to the results table and save to result_final
# some symbols are labelled NULL, substitute NULL to NA
#symbol <- gsub("NULL", NA, miRtb_data$target_symbol)
index <- match(rownames(results),miRtb_data$mature_mirna_acc)
rows <- miRtb_data$mature_mirna_acc[index]


matches <- miRtb_data.row(index)

match(rownames(results),miRtb_data$mature_mirna_acc)

head(symbol)
result_final<-cbind(symbol, results)
cbind.data.frame(results, symbol)
cbind()
head(result_final)
upreg <- subset(result_final, result_final$logFC>0)
print(head(upreg))
downreg <- subset(result_final, result_final$logFC<0)
print(head(downreg))
```
## Step 5: Save the result into "csv" file

```{r eval=T}
write.csv(result_final,file="DE_result.csv", quote=F)

# get a subset of result where logFC>0 ( i.e. Genes that are up regulated in cancer)
result_final_pos <- subset(result_final, result_final$logFC>0)
print(head(result_final_pos))
write.csv(result_final_pos,file="DE_result_up.csv", quote=F)

# get a subset of result where logFC<0 (i.e. Genes that are down regulated in cancer)
result_final_neg <- subset(result_final, result_final$logFC<0)
print(head(result_final_pos))
write.csv(result_final_neg,file="DE_result_down.csv", quote=F)



```
